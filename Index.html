<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Global Chat</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
*{box-sizing:border-box;font-family:Arial}
body{
  margin:0;
  background:#0b141a;
  height:100vh;
  display:flex;
  justify-content:center;
}
.chat-app{
  width:100%;
  max-width:420px;
  display:flex;
  flex-direction:column;
}
.chat-header{
  background:#202c33;
  color:#e9edef;
  padding:12px;
  display:flex;
  justify-content:space-between;
}
.username-top{
  color:#00a884;
  cursor:pointer;
  font-size:13px;
}
.chat-body{
  flex:1;
  padding:10px;
  overflow-y:auto;
}
.bubble{
  max-width:80%;
  padding:8px 12px;
  margin-bottom:8px;
  border-radius:8px;
  color:#e9edef;
  animation:fadeIn .3s ease;
}
.me{background:#005c4b;margin-left:auto}
.other{background:#202c33}

.exclusive{
  background:linear-gradient(135deg,#ff00cc,#3333ff);
  animation:glow 1.5s infinite alternate;
}

@keyframes glow{
  from{box-shadow:0 0 5px #ff00cc}
  to{box-shadow:0 0 15px #3333ff}
}
@keyframes fadeIn{
  from{opacity:0;transform:translateY(10px)}
  to{opacity:1;transform:translateY(0)}
}

.username{
  font-size:11px;
  color:#aebac1;
  display:flex;
  align-items:center;
  gap:4px;
}
.verify{
  width:12px;
  height:12px;
}

.chat-footer{
  display:flex;
  gap:8px;
  padding:10px;
  background:#202c33;
}
.chat-footer input{
  flex:1;
  border:none;
  border-radius:20px;
  padding:10px;
  background:#2a3942;
  color:white;
}
.chat-footer button{
  width:40px;
  border:none;
  border-radius:50%;
  background:#00a884;
  color:white;
  font-size:16px;
}
</style>
</head>
<body>

<div class="chat-app">
  <div class="chat-header">
    <span>GglChat</span>
    <span id="topName" class="username-top" onclick="changeName()"></span>
  </div>

  <div id="chat" class="chat-body"></div>

  <div class="chat-footer">
    <input id="msg" placeholder="Ketik pesan...">
    <button onclick="send()">➤</button>
  </div>
</div>

<script>
// ================= FIREBASE =================
const firebaseConfig = {
  apiKey: "AIzaSyBBT-3vGZYlb2A8_F93XsFHX54F-HuJyAU",
  authDomain: "ptube-6bd97.firebaseapp.com",
  databaseURL: "https://ptube-6bd97-default-rtdb.firebaseio.com",
  projectId: "ptube-6bd97",
  storageBucket: "ptube-6bd97.firebasestorage.app",
  messagingSenderId: "282752218641",
  appId: "1:282752218641:web:1230361a932c283518e3b0"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ============== ADMIN CONTROL ==============
const VERIFIED_USERS = {
  "RIFQY": true
};
const EXCLUSIVE_USERS = {
  "RIFQY": true
};
const VERIFY_ICON = "https://i.ibb.co.com/prJ0ppzm/New-Project-48-40-BF4-BE.png";

// ============== USERNAME ===================
let username = localStorage.getItem("name");
let changeCount = parseInt(localStorage.getItem("changeCount") || "0");

function updateTop(){
  document.getElementById("topName").innerText =
    `${username} (${changeCount}/2)`;
}

async function initUser(){
  if(!username){
    while(true){
      let temp="User"+Math.floor(Math.random()*9999);
      let s=await db.ref("users/"+temp).get();
      if(!s.exists()){
        username=temp;
        await db.ref("users/"+temp).set(true);
        localStorage.setItem("name",username);
        break;
      }
    }
  }
  updateTop();
}
initUser();

async function changeName(){
  if(changeCount>=2){
    alert("❌ Username hanya bisa diganti 2x");
    return;
  }
  let newName=prompt("Username baru:");
  if(!newName)return;
  newName=newName.trim();
  if(newName.length<3)return alert("Minimal 3 karakter");

  let s=await db.ref("users/"+newName).get();
  if(s.exists())return alert("Nama sudah dipakai");

  await db.ref("users/"+username).remove();
  await db.ref("users/"+newName).set(true);

  username=newName;
  changeCount++;
  localStorage.setItem("name",username);
  localStorage.setItem("changeCount",changeCount);
  updateTop();
}

// ================= CHAT ====================
function send(){
  let msg=document.getElementById("msg");
  if(!msg.value.trim())return;
  db.ref("global").push({
    user:username,
    text:msg.value,
    time:Date.now()
  });
  msg.value="";
}

db.ref("global").limitToLast(100).on("child_added",s=>{
  let d=s.val();
  let div=document.createElement("div");

  let cls = d.user===username?"me":"other";
  if(EXCLUSIVE_USERS[d.user]) cls+=" exclusive";

  div.className="bubble "+cls;

  let ver = VERIFIED_USERS[d.user]
    ? `<img src="${VERIFY_ICON}" class="verify">`
    : "";

  div.innerHTML=`
    <div class="username">${d.user}${ver}</div>
    ${d.text}
  `;
  chat.appendChild(div);
  chat.scrollTop=chat.scrollHeight;
});
</script>

</body>
</html>